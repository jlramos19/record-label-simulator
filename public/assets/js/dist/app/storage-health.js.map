{"version":3,"file":"storage-health.js","sourceRoot":"","sources":["../../../../src/app/storage-health.ts"],"names":[],"mappings":"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","sourcesContent":["const storageHealth = {\n  saveSizeBytes: null,\n  saveRawBytes: null,\n  localStorageUsedBytes: null,\n  localStorageFreeBytes: null,\n  localStorageAvailable: null,\n  localStorageDisabledReason: null,\n  externalConfigured: null,\n  lastMirror: null,\n  lastError: null,\n  updatedAt: null\n};\n\nconst pendingWarnings = [];\nlet warningHandler = null;\n\nfunction nowTs() {\n  return Date.now();\n}\n\nexport function setStorageWarningHandler(handler) {\n  warningHandler = typeof handler === \"function\" ? handler : null;\n  if (!warningHandler || !pendingWarnings.length) return;\n  const queued = pendingWarnings.splice(0, pendingWarnings.length);\n  queued.forEach((entry) => warningHandler(entry));\n}\n\nexport function reportStorageWarning(message, kind = \"storage\") {\n  const text = String(message || \"\").trim();\n  if (!text) return;\n  const payload = { message: text, kind };\n  if (warningHandler) {\n    warningHandler(payload);\n    return;\n  }\n  pendingWarnings.push(payload);\n}\n\nexport function updateStorageHealth(next = {}) {\n  Object.assign(storageHealth, next);\n  storageHealth.updatedAt = nowTs();\n  return storageHealth;\n}\n\nexport function recordStorageError({ scope = \"storage\", message = \"\", error = null, notify = null } = {}) {\n  const detail = error\n    ? (typeof error.message === \"string\" ? error.message : String(error))\n    : null;\n  const safeMessage = message || detail || \"Storage error\";\n  storageHealth.lastError = {\n    at: nowTs(),\n    scope,\n    message: safeMessage,\n    detail\n  };\n  storageHealth.updatedAt = storageHealth.lastError.at;\n  if (notify) {\n    reportStorageWarning(safeMessage, notify);\n  }\n  return storageHealth.lastError;\n}\n\nexport function recordExternalMirrorStatus({ target = \"unknown\", status = \"ok\", reason = null, error = null } = {}) {\n  const entry = {\n    at: nowTs(),\n    target,\n    status,\n    reason: reason || null,\n    detail: null\n  };\n  if (error) {\n    entry.detail = typeof error.message === \"string\" ? error.message : String(error);\n  }\n  storageHealth.lastMirror = entry;\n  storageHealth.updatedAt = entry.at;\n  if (status === \"failed\") {\n    storageHealth.lastError = {\n      at: entry.at,\n      scope: `external:${target}`,\n      message: reason || \"External storage mirror failed\",\n      detail: entry.detail || null\n    };\n    if (storageHealth.externalConfigured) {\n      const note = reason ? ` ${reason}.` : \" Write failed.\";\n      reportStorageWarning(`External storage mirror failed (${target}).${note} Local copy preserved.`, \"externalMirror\");\n    }\n  }\n  return entry;\n}\n\nexport function getStorageHealthSnapshot() {\n  try {\n    return JSON.parse(JSON.stringify(storageHealth));\n  } catch {\n    return { ...storageHealth };\n  }\n}\n"]}