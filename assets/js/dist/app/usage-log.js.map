{"version":3,"file":"usage-log.js","sourceRoot":"","sources":["../../../../src/app/usage-log.ts"],"names":[],"mappings":"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","sourcesContent":["// @ts-nocheck\nimport { queueUsageSessionWrite } from \"./file-storage.js\";\n\nconst SESSION_INDEX_KEY = \"rls_usage_session_index_v1\";\nconst SESSION_KEY_PREFIX = \"rls_usage_session_v1:\";\nconst SESSION_MAX = 6;\nconst EVENT_LIMIT = 360;\nconst ERROR_LIMIT = 20;\nconst TRAIL_LIMIT = 40;\nconst PERSIST_DELAY_MS = 250;\n\nlet storage = null;\nlet currentSession = null;\nlet actionTrail = [];\nlet persistTimer = null;\n\nfunction resolveStorage() {\n  if (typeof localStorage === \"undefined\") return null;\n  try {\n    const key = \"__rls_usage_log_test__\";\n    localStorage.setItem(key, \"1\");\n    localStorage.removeItem(key);\n    return localStorage;\n  } catch {\n    return null;\n  }\n}\n\nstorage = resolveStorage();\n\nfunction nowTs() {\n  return Date.now();\n}\n\nfunction pad(n) {\n  return String(n).padStart(2, \"0\");\n}\n\nfunction safeParse(raw, fallback) {\n  if (!raw) return fallback;\n  try {\n    return JSON.parse(raw);\n  } catch {\n    return fallback;\n  }\n}\n\nfunction loadSessionIndex() {\n  if (!storage) return [];\n  const raw = storage.getItem(SESSION_INDEX_KEY);\n  const parsed = safeParse(raw, []);\n  return Array.isArray(parsed) ? parsed : [];\n}\n\nfunction saveSessionIndex(index) {\n  if (!storage) return;\n  try {\n    storage.setItem(SESSION_INDEX_KEY, JSON.stringify(index));\n  } catch {\n    // ignore storage errors\n  }\n}\n\nfunction pruneSessionIndex(index) {\n  if (!storage) return index;\n  if (index.length <= SESSION_MAX) return index;\n  const overflow = index.length - SESSION_MAX;\n  const removed = index.splice(0, overflow);\n  removed.forEach((entry) => {\n    if (!entry?.id) return;\n    try {\n      storage.removeItem(`${SESSION_KEY_PREFIX}${entry.id}`);\n    } catch {\n      // ignore cleanup errors\n    }\n  });\n  return index;\n}\n\nfunction updateIndexEntry(id, updates) {\n  if (!storage || !id) return;\n  const index = loadSessionIndex();\n  const entry = index.find((item) => item?.id === id);\n  if (entry) Object.assign(entry, updates);\n  saveSessionIndex(index);\n}\n\nfunction buildSessionId() {\n  const now = new Date();\n  const stamp = `${now.getUTCFullYear()}${pad(now.getUTCMonth() + 1)}${pad(now.getUTCDate())}-${pad(now.getUTCHours())}${pad(now.getUTCMinutes())}${pad(now.getUTCSeconds())}`;\n  const rand = Math.random().toString(36).slice(2, 7);\n  return `RLS-SESSION-${stamp}-${rand}`;\n}\n\nfunction baseContext() {\n  return {\n    url: typeof location !== \"undefined\" ? location.href : null,\n    userAgent: typeof navigator !== \"undefined\" ? navigator.userAgent : null,\n    timezoneOffsetMin: new Date().getTimezoneOffset()\n  };\n}\n\nfunction persistSession() {\n  if (!currentSession) return;\n  if (storage) {\n    try {\n      storage.setItem(`${SESSION_KEY_PREFIX}${currentSession.id}`, JSON.stringify(currentSession));\n    } catch {\n      // ignore storage errors\n    }\n  }\n  queueUsageSessionWrite(currentSession);\n}\n\nfunction schedulePersist() {\n  if (!storage || !currentSession) return;\n  if (persistTimer) return;\n  persistTimer = setTimeout(() => {\n    persistTimer = null;\n    persistSession();\n  }, PERSIST_DELAY_MS);\n}\n\nfunction logToConsole(level, label, payload) {\n  if (typeof console === \"undefined\") return;\n  const safeLevel = level === \"warn\" || level === \"error\" ? level : \"info\";\n  const writer = console[safeLevel] || console.info;\n  writer(label, payload);\n}\n\nfunction appendEvent(entry, { isAction = false, reportToConsole = false, level = \"info\" } = {}) {\n  if (!currentSession) return;\n  currentSession.events.push(entry);\n  if (currentSession.events.length > EVENT_LIMIT) currentSession.events.shift();\n  currentSession.lastEventAt = entry.ts;\n  if (isAction) {\n    actionTrail.push({\n      ts: entry.ts,\n      type: entry.type,\n      route: entry.route,\n      gameTs: entry.gameTs,\n      payload: entry.payload\n    });\n    if (actionTrail.length > TRAIL_LIMIT) actionTrail.shift();\n    currentSession.trail = actionTrail.slice();\n  }\n  if (reportToConsole) {\n    logToConsole(level, `[usage] ${entry.type}`, entry);\n  }\n  schedulePersist();\n}\n\nfunction ensureSession(meta = {}) {\n  if (currentSession) return currentSession;\n  return startUsageSession(meta);\n}\n\nfunction normalizeErrorValue(value) {\n  if (value instanceof Error) {\n    return { message: value.message, stack: value.stack };\n  }\n  if (typeof value === \"string\") return value;\n  if (typeof value === \"number\" || typeof value === \"boolean\" || typeof value === \"bigint\") return String(value);\n  if (value === null || value === undefined) return null;\n  try {\n    return JSON.parse(JSON.stringify(value));\n  } catch {\n    return String(value);\n  }\n}\n\nexport function startUsageSession({ release } = {}) {\n  if (currentSession) return currentSession;\n  const now = nowTs();\n  const id = buildSessionId();\n  currentSession = {\n    id,\n    startedAt: now,\n    endedAt: null,\n    status: \"active\",\n    release: release?.patchId || null,\n    releaseTimestamp: release?.timestamp || null,\n    releaseChannel: release?.channel || null,\n    context: baseContext(),\n    events: [],\n    errors: [],\n    trail: []\n  };\n  actionTrail = [];\n  const index = loadSessionIndex();\n  index.push({ id, startedAt: now, endedAt: null, status: \"active\" });\n  saveSessionIndex(pruneSessionIndex(index));\n  appendEvent(\n    {\n      ts: now,\n      type: \"session.start\",\n      route: null,\n      gameTs: null,\n      payload: { release: currentSession.release, channel: currentSession.releaseChannel }\n    },\n    { reportToConsole: true, level: \"info\" }\n  );\n  schedulePersist();\n  return currentSession;\n}\n\nexport function recordUsageEvent(type, payload = {}, { route = null, gameTs = null, isAction = false, reportToConsole = false, level = \"info\" } = {}) {\n  ensureSession();\n  const entry = {\n    ts: nowTs(),\n    type,\n    route,\n    gameTs,\n    payload\n  };\n  appendEvent(entry, { isAction, reportToConsole, level });\n  return entry;\n}\n\nexport function updateUsageSessionContext(next = {}) {\n  ensureSession();\n  if (!currentSession.context || typeof currentSession.context !== \"object\") {\n    currentSession.context = {};\n  }\n  Object.assign(currentSession.context, next || {});\n  schedulePersist();\n  return currentSession.context;\n}\n\nexport function recordUsageError({\n  kind = \"error\",\n  message = \"\",\n  stack = null,\n  filename = null,\n  lineno = null,\n  colno = null,\n  reason = null,\n  route = null,\n  gameTs = null,\n  reportToConsole = true\n} = {}) {\n  ensureSession();\n  const ts = nowTs();\n  const entry = {\n    ts,\n    kind,\n    message: String(message || \"Unknown error\"),\n    stack: stack ? String(stack) : null,\n    source: filename ? { filename, lineno, colno } : null,\n    reason: normalizeErrorValue(reason),\n    route,\n    gameTs,\n    trail: actionTrail.slice()\n  };\n  currentSession.errors.push(entry);\n  if (currentSession.errors.length > ERROR_LIMIT) currentSession.errors.shift();\n  currentSession.status = \"error\";\n  currentSession.lastErrorAt = ts;\n  currentSession.trail = actionTrail.slice();\n  updateIndexEntry(currentSession.id, { status: \"error\", lastErrorAt: ts });\n  appendEvent(\n    {\n      ts,\n      type: \"session.error\",\n      route,\n      gameTs,\n      payload: { kind: entry.kind, message: entry.message }\n    },\n    { reportToConsole: false }\n  );\n  if (reportToConsole) {\n    logToConsole(\"error\", \"[usage] session.error\", entry);\n  }\n  schedulePersist();\n  return entry;\n}\n\nexport function finalizeUsageSession(reason = \"ended\") {\n  if (!currentSession) return null;\n  const ts = nowTs();\n  currentSession.endedAt = ts;\n  currentSession.endReason = reason;\n  if (currentSession.status !== \"error\") currentSession.status = \"ended\";\n  updateIndexEntry(currentSession.id, {\n    endedAt: ts,\n    endReason: reason,\n    status: currentSession.status\n  });\n  appendEvent(\n    {\n      ts,\n      type: \"session.end\",\n      route: null,\n      gameTs: null,\n      payload: { reason }\n    },\n    { reportToConsole: true, level: \"info\" }\n  );\n  persistSession();\n  return currentSession;\n}\n\nexport function getUsageSessionSnapshot() {\n  if (!currentSession) return null;\n  try {\n    return JSON.parse(JSON.stringify(currentSession));\n  } catch {\n    return { ...currentSession };\n  }\n}\n\nexport function getUsageSessionId() {\n  return currentSession?.id || null;\n}\n"]}